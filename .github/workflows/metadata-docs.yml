name: Generate Log Analytics Metadata Docs

permissions:
  contents: write
  pull-requests: write
  id-token: write
on:
  schedule:
    - cron: "0 8 * * *"      # Daily at 08:00 UTC
  workflow_dispatch: {}      # Allow manual runs
jobs:
  generate-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      # Login to Azure so az CLI is authenticated
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      # Run your PowerShell script
      - name: Run metadata document generator
        shell: pwsh
        run: pwsh ./.github/scripts/metadata-docs.ps1 -MaxParallel 8 -OnlyChanged
        env:
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
      # If no changes, skip PR creation
      - name: Check for changes
        id: git_status
        run: |
          if git diff --quiet && [ -z "$(git ls-files -o --exclude-standard)" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      - name: Create Pull Request
        if: steps.git_status.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Automated: Refresh Log Analytics metadata docs"
          title: "Automated metadata documentation update"
          body: |
            This PR was automatically generated by GitHub Actions.
            
            - Updated metadata
            - Regenerated per-table docs
            - Rebuilt index, category, and resource-type pages
          branch: "auto/metadata-docs"
          labels: "automation,docs,metadata"
