---
title: Configure Bring Your Own Storage (BYOS) for the .NET Profiler and Snapshot Debugger
description: Configure Bring Your Own Storage (BYOS) for Azure Monitor Application Insights Profiler for .NET and Snapshot Debugger.
ms.reviewer: charles.weininger
reviewer: cweining
ms.topic: how-to
ms.date: 01/23/2025
ms.custom: devdivchpfy22, devx-track-azurepowershell, engagement
ai-usage: ai-assisted
---

# Configure Bring Your Own Storage (BYOS) for Application Insights Profiler for .NET and Snapshot Debugger

When you use [Application Insights Profiler for .NET](./profiler-overview.md) or [Snapshot Debugger](../snapshot-debugger/snapshot-debugger.md), artifacts generated by your application are uploaded by default into Azure Storage accounts managed by Microsoft over the public internet. Microsoft controls and covers the cost for:
- Processing
- Analysis
- Encryption-at-rest and lifetime management policies

However, Bring Your Own Storage (BYOS) is an optional configuration that gives you more control over where these artifacts are stored and how they're accessed. When you BYOS, you control and cover the cost for encryption-at-rest policies, lifetime management policies, and network access.

> [!NOTE]
> BYOS is **required** if you're enabling [Azure Private Link](../logs/private-link-security.md) or [customer-managed keys](../logs/customer-managed-keys.md).

Currently, BYOS isn't supported for [storing Code Optimizations trace data in Application Insights.](../optimization-insights/code-optimizations-profiler-overview.md#code-optimizations-1)

In this guide, you learn how to:
> [!div class="checklist"]
> - Create and verify prerequisites to ensure your storage account is ready.
> - Grant Diagnostic Services access to your storage account.
> - Link your storage account with your Application Insights resource.

## Prerequisites

Before you begin, ensure you have:

- An Azure subscription with appropriate permissions
- An existing Application Insights resource
- A storage account created **in the same location** as your Application Insights resource
- One of the following tools installed:
  - [Azure PowerShell 4.2.0 or greater](/powershell/azure/install-azure-powershell), or
  - [Azure CLI](/cli/azure/install-azure-cli), or
  - Access to Azure portal for Azure Resource Manager template deployment

### Verify your storage account location

To verify your storage account is in the correct location:

1. Open the [Azure portal](https://portal.azure.com).
1. Navigate to your storage account.
1. Check the **Location** field matches your Application Insights resource location.

> [!IMPORTANT]
> If you're using Private Link, you must also configure your storage account to allow connection from Trusted Microsoft Services. See [Storage network security documentation](/azure/storage/common/storage-network-security#trusted-microsoft-services) for details.

## Step 1: Grant Diagnostic Services access to your storage account

The `Diagnostic Services Trusted Storage Access` application needs permission to write data to your storage account.

### Assign the Storage Blob Data Contributor role

1. In the [Azure portal](https://portal.azure.com), navigate to your storage account.

1. Select **Access control (IAM)** from the left menu.

1. Select **Add** > **Add role assignment**.

1. On the **Add role assignment** page, configure the following:

    | Setting | Value |
    | --- | --- |
    | **Role** tab | Select **Storage Blob Data Contributor** |
    | **Members** tab > Assign access to | Select **User, group, or service principal** |
    | **Members** tab > Members | Select **+ Select members** |

1. In the **Select members** pane:
   1. Search for `Diagnostic Services Trusted Storage Access`.
   1. Select the application from the results.
   1. Select **Select**.

1. Select **Review + assign**.

    :::image type="content" source="media/profiler-bring-your-own-storage/add-role-assignment-page.png" alt-text="Screenshot that shows the role assignment page in the Azure portal.":::

### Verify the role assignment

1. Stay on the **Access control (IAM)** page.
1. Select the **Role assignments** tab.
1. Verify `Diagnostic Services Trusted Storage Access` appears with the **Storage Blob Data Contributor** role.

    :::image type="content" source="media/profiler-bring-your-own-storage/figure-11.png" alt-text="Screenshot that shows the IAM screen after Role assignments.":::

> [!TIP]
> If you don't see the application in the list, wait a few minutes and refresh the page. Role assignments can take up to 5 minutes to propagate.

## Step 2: Link your storage account to Application Insights

Choose one of the following methods to link your storage account. We recommend using PowerShell or Azure CLI for easier troubleshooting.

#### [PowerShell](#tab/azure-powershell)

### Install the Application Insights PowerShell module

1. Open PowerShell as an administrator.

1. Install the Application Insights PowerShell extension:

    ```powershell
    Install-Module -Name Az.ApplicationInsights -Force
    ```

1. If prompted to install from PSGallery, type `Y` and press Enter.

### Sign in to Azure

Sign in with your Azure account:

```powershell
Connect-AzAccount -Subscription "{subscription_id}"
```

Replace `{subscription_id}` with your actual subscription ID.

> [!TIP]
> To find your subscription ID, run `Get-AzSubscription` or check the Azure portal under **Subscriptions**.

For more information, see [Connect-AzAccount documentation](/powershell/module/az.accounts/connect-azaccount).

### Remove previous storage account links (if any)

If your Application Insights resource was previously linked to a different storage account, remove that link:

```powershell
Remove-AzApplicationInsightsLinkedStorageAccount -ResourceGroupName "{resource_group_name}" -Name "{application_insights_name}"
```

Replace:
- `{resource_group_name}` with your resource group name
- `{application_insights_name}` with your Application Insights resource name

**Example:**

```powershell
Remove-AzApplicationInsightsLinkedStorageAccount -ResourceGroupName "byos-test" -Name "byos-test-westus2-ai"
```

> [!NOTE]
> If no previous storage account is linked, you might see a "not found" message. This is expected and you can proceed.

### Link your storage account

1. Get a reference to your storage account:

    ```powershell
    $storageAccount = Get-AzStorageAccount -ResourceGroupName "{resource_group_name}" -Name "{storage_account_name}"
    ```

    Replace:
    - `{resource_group_name}` with your resource group name
    - `{storage_account_name}` with your storage account name

1. Link the storage account to Application Insights:

    ```powershell
    New-AzApplicationInsightsLinkedStorageAccount -ResourceGroupName "{resource_group_name}" -Name "{application_insights_name}" -LinkedStorageAccountResourceId $storageAccount.Id
    ```

    Replace:
    - `{resource_group_name}` with your resource group name
    - `{application_insights_name}` with your Application Insights resource name

**Complete example:**

```powershell
# Set your values
$resourceGroup = "byos-test"
$storageAccountName = "byosteststoragewestus2"
$appInsightsName = "byos-test-westus2-ai"

# Remove any previous linked storage account (optional)
Remove-AzApplicationInsightsLinkedStorageAccount -ResourceGroupName $resourceGroup -Name $appInsightsName

# Get storage account
$storageAccount = Get-AzStorageAccount -ResourceGroupName $resourceGroup -Name $storageAccountName

# Link to Application Insights
New-AzApplicationInsightsLinkedStorageAccount -ResourceGroupName $resourceGroup -Name $appInsightsName -LinkedStorageAccountResourceId $storageAccount.Id
```

### Verify the link was created

After running the link command, you should see output similar to:

```powershell
Id        : /subscriptions/{subscription}/resourcegroups/byos-test/providers/microsoft.insights/components/byos-test-westus2-ai/linkedstorageaccounts/serviceprofiler
Name      : serviceprofiler
Type      : microsoft.insights/components/linkedstorageaccounts
LinkedStorageAccount : /subscriptions/{subscription}/resourceGroups/byos-test/providers/Microsoft.Storage/storageAccounts/byosteststoragewestus2
```

If you see an error, check that:
- Your storage account and Application Insights resource are in the same location
- You granted the Storage Blob Data Contributor role correctly in Step 1
- You're signed in to the correct subscription

#### [Azure CLI](#tab/azure-cli)

### Install the Application Insights extension

1. Install the Application Insights CLI extension:

    ```azurecli
    az extension add -n application-insights
    ```

1. If the extension is already installed, update it:

    ```azurecli
    az extension update -n application-insights
    ```

### Sign in to Azure

Sign in to your Azure account:

```azurecli
az login
```

If you have multiple subscriptions, set the active subscription:

```azurecli
az account set --subscription "{subscription_id}"
```

Replace `{subscription_id}` with your actual subscription ID.

### Link your storage account

Run the following command to link your storage account:

```azurecli
az monitor app-insights component linked-storage link --resource-group "{resource_group_name}" --app "{application_insights_name}" --storage-account "{storage_account_name}"
```

Replace:
- `{resource_group_name}` with your resource group name
- `{application_insights_name}` with your Application Insights resource name
- `{storage_account_name}` with your storage account name

**Example:**

```azurecli
az monitor app-insights component linked-storage link --resource-group "byos-test" --app "byos-test-westus2-ai" --storage-account "byosteststoragewestus2"
```

### Verify the link was created

You should see output similar to:

```json
{
  "id": "/subscriptions/{subscription}/resourcegroups/byos-test/providers/microsoft.insights/components/byos-test-westus2-ai/linkedstorageaccounts/serviceprofiler",
  "linkedStorageAccount": "/subscriptions/{subscription}/resourceGroups/byos-test/providers/Microsoft.Storage/storageAccounts/byosteststoragewestus2",
  "name": "serviceprofiler",
  "resourceGroup": "byos-test",
  "type": "microsoft.insights/components/linkedstorageaccounts"
}
```

If you see an error, check that:
- Your storage account and Application Insights resource are in the same location
- You granted the Storage Blob Data Contributor role correctly in Step 1
- The extension is properly installed

> [!NOTE]
> To update or remove a linked storage account, see the [Application Insights CLI documentation](/cli/azure/monitor/app-insights/component/linked-storage).

#### [Resource Manager template](#tab/azure-resource-manager)

### Create the Resource Manager template

1. Create a new file named `byos.template.json` on your local machine.

1. Copy and paste the following content into the file:

    ```json
    {
      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "applicationinsights_name": {
          "type": "String"
        },
        "storageaccount_name": {
          "type": "String"
        }
      },
      "variables": {},
      "resources": [
        {
          "name": "[concat(parameters('applicationinsights_name'), '/serviceprofiler')]",
          "type": "Microsoft.Insights/components/linkedStorageAccounts",
          "apiVersion": "2020-03-01-preview",
          "properties": {
            "linkedStorageAccount": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageaccount_name'))]"
          }
        }
      ],
      "outputs": {}
    }
    ```

1. Save the file.

### Deploy the template using PowerShell

1. Open PowerShell.

1. Sign in to Azure:

    ```powershell
    Connect-AzAccount -Subscription "{subscription_id}"
    ```

    Replace `{subscription_id}` with your subscription ID.

1. Deploy the template:

    ```powershell
    New-AzResourceGroupDeployment -ResourceGroupName "{resource_group_name}" -TemplateFile "{path_to_template_file}"
    ```

    Replace:
    - `{resource_group_name}` with your resource group name
    - `{path_to_template_file}` with the full path to your `byos.template.json` file

    **Example:**

    ```powershell
    New-AzResourceGroupDeployment -ResourceGroupName "byos-test" -TemplateFile "D:\Docs\byos.template.json"
    ```

1. When prompted, provide the following parameters:

    | Parameter | Description | Example |
    |-----------|-------------|---------|
    | `application_insights_name` | The name of your Application Insights resource | `byos-test-westus2-ai` |
    | `storage_account_name` | The name of your storage account | `byosteststoragewestus2` |

### Verify the deployment

You should see output similar to:

```powershell
Supply values for the following parameters:
(Type !? for Help.)
application_insights_name: byos-test-westus2-ai
storage_account_name: byosteststoragewestus2

DeploymentName          : byos.template
ResourceGroupName      : byos-test
ProvisioningState       : Succeeded
Timestamp               : 4/16/2020 1:24:57 AM
Mode                    : Incremental
TemplateLink            :
Parameters              :
                          Name                            Type                       Value
                          ==============================  =========================  =========
                          application_insights_name        String                     byos-test-westus2-ai
                          storage_account_name             String                     byosteststoragewestus2

Outputs                 :
DeploymentDebugLogLevel :
```

Look for `ProvisioningState : Succeeded` to confirm the deployment worked.

If the deployment fails, check that:
- The template file path is correct
- Your storage account and Application Insights resource are in the same location
- You granted the Storage Blob Data Contributor role correctly in Step 1

---

## Step 3: Enable the .NET Profiler or Snapshot Debugger

Now that your storage account is linked, enable the diagnostic tools:

1. In the [Azure portal](https://portal.azure.com), navigate to your application resource (for example, App Service).

1. In the left menu, select **Application Insights**.

1. On the Application Insights page, locate the **Code-level diagnostics** section.

1. Toggle on **Application Insights Profiler** or **Snapshot Debugger** as needed.

    :::image type="content" source="media/profiler-bring-your-own-storage/figure-20.png" alt-text="Screenshot that shows the code-level diagnostics in the Azure portal.":::

1. Select **Save** at the top of the page.

### Verify BYOS is working

After enabling the .NET Profiler or Snapshot Debugger:

1. Wait 5-10 minutes for data collection to begin.
1. Navigate to your storage account in the Azure portal.
1. Select **Containers** from the left menu.
1. Verify that new containers have been created for storing artifacts.

If you don't see new containers after 15 minutes, see the [Troubleshooting](#troubleshooting) section.

## How your storage account is accessed

Understanding how artifacts flow through your storage account can help with troubleshooting:

1. **Agents upload artifacts** - Agents running in your virtual machines or Azure App Service upload artifacts (profiles, snapshots, and symbols) to blob containers in your account. This process contacts the .NET Profiler or Snapshot Debugger to obtain a shared access signature token to a new blob in your storage account.

1. **Diagnostic Services process data** - The .NET Profiler or Snapshot Debugger analyzes the incoming blob and writes back the analysis results and log files into blob storage. Depending on available compute capacity, this process might occur anytime after upload.

1. **You view the results** - When you view Profiler traces or Snapshot Debugger analysis, the service fetches the analysis results from blob storage.

## Troubleshooting

For assistance with troubleshooting BYOS, see the dedicated troubleshooting documentation:

- [.NET Profiler troubleshooting](./profiler-troubleshooting.md#troubleshoot-bring-your-own-storage-byos)
- [Snapshot Debugger troubleshooting](../snapshot-debugger/snapshot-debugger-troubleshoot.md#troubleshoot-bring-your-own-storage-byos)

**Common issues:**

- **Storage account not in the same location** - Verify your storage account and Application Insights resource are in the same Azure region.
- **Role assignment not propagated** - Wait 5-10 minutes after assigning the Storage Blob Data Contributor role before linking your storage account.
- **Private Link not configured** - If using Private Link, ensure you configured your storage account to allow Trusted Microsoft Services.

## Frequently asked questions

This section provides answers to common questions about configuring BYOS for .NET Profiler and Snapshot Debugger.

### If I enabled the .NET Profiler/Snapshot Debugger and BYOS, is my data migrated into my storage account?

No, it won't. Only new data collected after enabling BYOS is stored in your storage account.

### Does BYOS work with encryption-at-rest and customer-managed keys?

Yes. To be precise, BYOS is a requirement to have the .NET Profiler/Snapshot Debugger enabled with customer-manager keys.

### Does BYOS work in an environment isolated from the internet?

Yes. BYOS is a requirement for isolated network scenarios.

### Does BYOS work with both customer-managed keys and Private Link enabled?

Yes, it's possible.

### If I enabled BYOS, can I go back to using Diagnostic Services storage accounts to store my collected data?

Yes, you can. However, we don't currently support data migration from your BYOS to the Diagnostic Services storage accounts.

### After I enable BYOS, do I take over all the related costs of storage and networking?

Yes. You're responsible for all costs related to storage and networking for your BYOS storage account.

## Next steps

- Troubleshoot BYOS for [.NET Profiler](./profiler-troubleshooting.md#troubleshoot-bring-your-own-storage-byos) and [Snapshot Debugger](../snapshot-debugger/snapshot-debugger-troubleshoot.md#troubleshoot-bring-your-own-storage-byos)
- [Learn more about Application Insights Profiler for .NET](./profiler-overview.md)
- [Learn more about Snapshot Debugger](../snapshot-debugger/snapshot-debugger.md)